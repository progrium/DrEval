#!/usr/bin/env python

from twisted.python import log
from twisted.internet import reactor, defer
from twisted.web import server
from ampoule import pool
import sys

from doctoreval import web, worker

def main(args=None):
    port = 8123
    log.startLogging(sys.stdout)
    resource = web.ScriptResource()
    @defer.inlineCallbacks
    def run_pp():
        pp = pool.ProcessPool(worker.Servlet, min=1, max=1, timeout=30)
        resource.pp = pp
        yield pp.start()
    reactor.listenTCP(port, server.Site(resource))
    reactor.callLater(1, run_pp)
    reactor.run()

if __name__ == '__main__':
    main()